name: Fix Old Archives
on:
  workflow_dispatch:

jobs:
  fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fix old archive files
        run: |
          # Set up a temporary directory
          mkdir -p new_wods
          
          if [ ! -d "wods" ] || [ -z "$(ls -A wods/*.html 2>/dev/null)" ]; then
            echo "wods/ directory not found or is empty. Nothing to fix."
            exit 0
          fi

          # Loop over every HTML file in the wods directory
          for file in wods/*.html; do
            FILENAME=$(basename "$file")
            DATE=$(echo $FILENAME | sed 's/\.html//')
            echo "Processing $FILENAME..."

            if grep -q "back-link" "$file"; then
              echo "...already has a link. Skipping."
              cp "$file" "new_wods/$FILENAME"
            else
              echo "...is an old file. Adding template."
              OLD_CONTENT=$(cat "$file")
              
              # --- THE FIX ---
              # Use a group of 'echo' commands to write the file.
              # This avoids all YAML/shell 'EOF' conflicts.
              (
                echo "<!DOCTYPE html>"
                echo "<html lang=\"en\">"
                echo "<head>"
                echo "  <meta charset=\"UTF-8\" />"
                echo "  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />"
                echo "  <title>WOD: ${DATE}</title>"
                echo "  <link href=\"https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;700&display=swap\" rel=\"stylesheet\">"
                echo "  <style>"
                echo "    body { margin:0; background:#0f0f0f; color:#eaeaea; font-family:Roboto,sans-serif; text-align:center; padding: 20px; }"
                echo "    .back-link { display: inline-block; margin-bottom: 30px; padding: 10px 20px; background: #4da6ff; color: #0f0f0f; font-weight: bold; text-decoration: none; border-radius: 8px; font-family: Anton, sans-serif; }"
                echo "    .back-link:hover { background: #fff; }"
                echo "    .wod-content { border: 1px solid #333; padding: 10px; border-radius: 8px; max-width: 800px; margin: 0 auto; }"
                echo "  </style>"
                echo "</head>"
                echo "<body>"
                echo "  <a href=\"../index.html\" class=\"back-link\">&laquo; Back to Main Page</a>"
                echo "  <div class=\"wod-content\">"
                echo "${OLD_CONTENT}"
                echo "  </div>"
                echo "</body>"
                echo "</html>"
              ) > "new_wods/$FILENAME"
            fi
          done

          # Replace the old wods directory with the new, fixed one
          rm -rf wods
          mv new_wods wods
          
          # --- Commit and push the changes ---
          git config --global user.name "GarageWODBot"
          git config --global user.email "you@example.com"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add wods/
            git commit -m "Fix: Add back-links to old archive files"
            git push
          else
            echo "No old files needed fixing."
          fi
