name: Auto Update Garage WOD Display

on:
  repository_dispatch:
    types: [update_wod]
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update WOD HTML
        run: |
          # Configure Git identity for commit
          git config --global user.name "GarageWODBot"
          git config --global user.email "you@example.com"
          
          # --- 1. SETUP & DECODE ---
          DATE=$(date +%F)
          mkdir -p wods
          echo "${{ github.event.client_payload.html_b64 }}" | base64 --decode > temp_wod.html
          LATEST_CONTENT=$(cat temp_wod.html)

          # --- 2. CREATE THE NEW ARCHIVE PAGE ---
          # Replaced 'cat <<EOF' with 'echo' commands to fix YAML error
          (
            echo "<!DOCTYPE html>"
            echo "<html lang=\"en\">"
            echo "<head>"
            echo "  <meta charset=\"UTF-8\" />"
            echo "  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />"
            echo "  <title>WOD: ${DATE}</title>"
            echo "  <link href=\"https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;700&display=swap\" rel=\"stylesheet\">"
            echo "  <style>"
            echo "    body { margin:0; background:#0f0f0f; color:#eaeaea; font-family:Roboto,sans-serif; text-align:center; padding: 20px; }"
            echo "    .back-link { display: inline-block; margin-bottom: 30px; padding: 10px 20px; background: #4da6ff; color: #0f0f0f; font-weight: bold; text-decoration: none; border-radius: 8px; font-family: Anton, sans-serif; }"
            echo "    .back-link:hover { background: #fff; }"
            echo "    .wod-content { border: 1px solid #333; padding: 10px; border-radius: 8px; max-width: 800px; margin: 0 auto; }"
            echo "  </style>"
            echo "</head>"
            echo "<body>"
            echo "  <a href=\"../index.html\" class=\"back-link\">&laquo; Back to Main Page</a>"
            echo "  <div class=\"wod-content\">"
            echo "${LATEST_CONTENT}"
            echo "  </div>"
            echo "</body>"
            echo "</html>"
          ) > wods/${DATE}.html

          # --- 3. BUILD THE MAIN index.html PAGE ---
          # Replaced 'cat <<EOF' with 'echo' commands
          (
            echo "<!DOCTYPE html>"
            echo "<html lang=\"en\">"
            echo "<head>"
            echo "  <meta charset=\"UTF-8\" />"
            echo "  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />"
            echo "  <title>Garage WOD Display</title>"
            echo "  <link href=\"https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;700&display=swap\" rel=\"stylesheet\">"
            echo "</head>"
            echo "<body style=\"margin:0;background:#0f0f0f;color:#eaeaea;font-family:Roboto,sans-serif;text-align:center;\">"
            echo "  <div id=\"latest\" style=\"padding:20px;\">"
            echo "${LATEST_CONTENT}"
            echo "  </div>"
            echo "  <div id=\"archive\" style=\"border-top:2px solid #333;margin-top:40px;padding:20px;\">"
            echo "    <h2 style=\"font-family:Anton,sans-serif;color:#4da6ff;\">Workout Archive</h2>"
            echo "    <ul style=\"list-style:none;padding:0;\">"
          ) > index.html
          
          # Add newest link at the top of the list
          echo "    <li><a href='wods/${DATE}.html' style='color:#4da6ff;'>${DATE}</a></li>" >> index.html

          # Include previous archive entries if they exist
          if [ -f archive_list.txt ]; then
            cat archive_list.txt >> index.html
          fi

          # Update archive list file
          echo "    <li><a href='wods/${DATE}.html' style='color:#4da6ff;'>${DATE}</a></li>" > new_archive.txt
          if [ -f archive_list.txt ]; then
            # --- THIS IS THE .json TYPO FIX ---
            cat archive_list.txt >> new_archive.txt
          fi
          mv new_archive.txt archive_list.txt

          # Close out the HTML
          # Replaced 'cat <<EOF' with 'echo' commands
          (
            echo "      </ul>"
            echo "    </div>"
            echo "    <div style=\"font-size:0.8rem;color:#777;margin-top:20px;\">Garage WOD Display Â© 2025</div>"
            echo "  </body>"
            echo "</html>"
          ) >> index.html
          
          # Clean up the temporary file
          rm temp_wod.html
          
          # --- 4. COMMIT & PUSH ---
          if [ -n "$(git status --porcelain)" ]; then
            git add index.html archive_list.txt wods/
            git commit -m "Auto update WOD for ${DATE}"
            git push
          else
            echo "No changes to commit."
          fi
