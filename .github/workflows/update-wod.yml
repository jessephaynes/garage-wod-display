name: Auto Update Garage WOD Display

on:
  repository_dispatch:
    types: [update_wod]
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update WOD HTML
        run: |
          # Configure Git identity for commit
          git config --global user.name "GarageWODBot"
          git config --global user.email "you@example.com"
          
          # --- 1. SETUP & DECODE ---
          DATE=$(date +%F)
          mkdir -p wods

          # Decode the payload into a temporary file first
          echo "${{ github.event.client_payload.html_b64 }}" | base64 --decode > temp_wod.html
          
          # Read the raw WOD content into a variable
          LATEST_CONTENT=$(cat temp_wod.html)

          # --- 2. CREATE THE NEW ARCHIVE PAGE (WITH BACK LINK) ---
          # This replaces your "cp index.html wods/${DATE}.html" line
          cat > wods/${DATE}.html <<EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>WOD: ${DATE}</title>
            <link href="https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
            <style>
              body { margin:0; background:#0f0f0f; color:#eaeaea; font-family:Roboto,sans-serif; text-align:center; padding: 20px; }
              /* Style for the "Back" link */
              .back-link {
                display: inline-block;
                margin-bottom: 30px;
                padding: 10px 20px;
                background: #4da6ff;
                color: #0f0f0f;
                font-weight: bold;
                text-decoration: none;
                border-radius: 8px;
                font-family: Anton, sans-serif;
              }
              .back-link:hover { background: #fff; }
              .wod-content { border: 1px solid #333; padding: 10px; border-radius: 8px; max-width: 800px; margin: 0 auto; }
            </style>
          </head>
          <body>
            
            <a href="../index.html" class="back-link">&laquo; Back to Main Page</a>

            <div class="wod-content">
              ${LATEST_CONTENT}
            </div>

          </body>
          </html>
          EOF

          # --- 3. BUILD THE MAIN index.html PAGE ---
          cat > index.html <<EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>Garage WOD Display</title>
            <link href="https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
          </head>
          <body style="margin:0;background:#0f0f0f;color:#eaeaea;font-family:Roboto,sans-serif;text-align:center;">
            <div id="latest" style="padding:20px;">
              ${LATEST_CONTENT}
            </div>
          
            <div id="archive" style="border-top:2px solid #333;margin-top:40px;padding:20px;">
              <h2 style="font-family:Anton,sans-serif;color:#4da6ff;">Workout Archive</h2>
              <ul style="list-style:none;padding:0;">
          EOF
          
          # Add newest link at the top of the list
          echo "    <li><a href='wods/${DATE}.html' style='color:#4da6ff;'>${DATE}</a></li>" >> index.html

          # Include previous archive entries if they exist
          if [ -f archive_list.txt ]; then
            cat archive_list.txt >> index.html
          fi

          # Update archive list file
          echo "    <li><a href='wods/${DATE}.html' style='color:#4da6ff;'>${DATE}</a></li>" > new_archive.txt
          if [ -f archive_list.txt ]; then
            cat archive_list.txt >> new_archive.txt
          fi
          mv new_archive.txt archive_list.txt

          # Close out the HTML
          cat >> index.html <<EOF
                </ul>
              </div>
              <div style="font-size:0.8rem;color:#777;margin-top:20px;">Garage WOD Display Â© 2025</div>
            </body>
            </html>
          EOF
          
          # Clean up the temporary file
          rm temp_wod.html
          
          # --- 4. COMMIT & PUSH (Your logic is unchanged) ---
          if [ -n "$(git status --porcelain)" ]; then
            git add index.html archive_list.txt wods/
            git commit -m "Auto update WOD for ${DATE}"
            git push
          else
            echo "No changes to commit."
          fi
